<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Predicting Collision Risk from Historical Collision Data Messages (CDMs) using Machine Learning | Futurifai Blog</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Predicting Collision Risk from Historical Collision Data Messages (CDMs) using Machine Learning" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="$3^{rd}$ place solution for ESA’s Collision Risk Prediction Challenge hosted on Kelvins platform. (Please note that an extension of this solution is being prepated for publication)" />
<meta property="og:description" content="$3^{rd}$ place solution for ESA’s Collision Risk Prediction Challenge hosted on Kelvins platform. (Please note that an extension of this solution is being prepated for publication)" />
<link rel="canonical" href="https://rasitabay.github.io/blog/collision%20risk/satellites/deep%20learning/manhattan-lstm/2020/04/22/ESA-Collision-Risk-Prediction.html" />
<meta property="og:url" content="https://rasitabay.github.io/blog/collision%20risk/satellites/deep%20learning/manhattan-lstm/2020/04/22/ESA-Collision-Risk-Prediction.html" />
<meta property="og:site_name" content="Futurifai Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-22T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"$3^{rd}$ place solution for ESA’s Collision Risk Prediction Challenge hosted on Kelvins platform. (Please note that an extension of this solution is being prepated for publication)","dateModified":"2020-04-22T00:00:00-05:00","datePublished":"2020-04-22T00:00:00-05:00","headline":"Predicting Collision Risk from Historical Collision Data Messages (CDMs) using Machine Learning","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://rasitabay.github.io/blog/collision%20risk/satellites/deep%20learning/manhattan-lstm/2020/04/22/ESA-Collision-Risk-Prediction.html"},"url":"https://rasitabay.github.io/blog/collision%20risk/satellites/deep%20learning/manhattan-lstm/2020/04/22/ESA-Collision-Risk-Prediction.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://rasitabay.github.io/blog/feed.xml" title="Futurifai Blog" /><link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Predicting Collision Risk from Historical Collision Data Messages (CDMs) using Machine Learning | Futurifai Blog</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Predicting Collision Risk from Historical Collision Data Messages (CDMs) using Machine Learning" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="$3^{rd}$ place solution for ESA’s Collision Risk Prediction Challenge hosted on Kelvins platform. (Please note that an extension of this solution is being prepated for publication)" />
<meta property="og:description" content="$3^{rd}$ place solution for ESA’s Collision Risk Prediction Challenge hosted on Kelvins platform. (Please note that an extension of this solution is being prepated for publication)" />
<link rel="canonical" href="https://rasitabay.github.io/blog/collision%20risk/satellites/deep%20learning/manhattan-lstm/2020/04/22/ESA-Collision-Risk-Prediction.html" />
<meta property="og:url" content="https://rasitabay.github.io/blog/collision%20risk/satellites/deep%20learning/manhattan-lstm/2020/04/22/ESA-Collision-Risk-Prediction.html" />
<meta property="og:site_name" content="Futurifai Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-22T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"$3^{rd}$ place solution for ESA’s Collision Risk Prediction Challenge hosted on Kelvins platform. (Please note that an extension of this solution is being prepated for publication)","dateModified":"2020-04-22T00:00:00-05:00","datePublished":"2020-04-22T00:00:00-05:00","headline":"Predicting Collision Risk from Historical Collision Data Messages (CDMs) using Machine Learning","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://rasitabay.github.io/blog/collision%20risk/satellites/deep%20learning/manhattan-lstm/2020/04/22/ESA-Collision-Risk-Prediction.html"},"url":"https://rasitabay.github.io/blog/collision%20risk/satellites/deep%20learning/manhattan-lstm/2020/04/22/ESA-Collision-Risk-Prediction.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://rasitabay.github.io/blog/feed.xml" title="Futurifai Blog" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Futurifai Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Predicting Collision Risk from Historical Collision Data Messages (CDMs) using Machine Learning</h1><p class="page-description">$3^{rd}$  place solution for ESA&#39;s Collision Risk Prediction Challenge hosted on Kelvins platform. (Please note that an extension of this solution is being prepated for publication)</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-04-22T00:00:00-05:00" itemprop="datePublished">
        Apr 22, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      14 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#collision risk">collision risk</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Satellites">Satellites</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Deep Learning">Deep Learning</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Manhattan-LSTM">Manhattan-LSTM</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/rasitabay/blog/tree/master/_notebooks/2020-04-22-ESA-Collision-Risk-Prediction.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/blog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/rasitabay/blog/master?filepath=_notebooks%2F2020-04-22-ESA-Collision-Risk-Prediction.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/rasitabay/blog/blob/master/_notebooks/2020-04-22-ESA-Collision-Risk-Prediction.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#1.-Introduction">1. Introduction </a></li>
<li class="toc-entry toc-h2"><a href="#2.-Data-Preparation">2. Data Preparation </a></li>
<li class="toc-entry toc-h2"><a href="#3.-Manhattan-LSTM-Model">3. Manhattan-LSTM Model </a></li>
<li class="toc-entry toc-h2"><a href="#4.-Results">4. Results </a></li>
<li class="toc-entry toc-h2"><a href="#5.-References">5. References </a></li>
<li class="toc-entry toc-h2"><a href="#6.-Code">6. Code </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-04-22-ESA-Collision-Risk-Prediction.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="1.-Introduction">
<a class="anchor" href="#1.-Introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. Introduction<a class="anchor-link" href="#1.-Introduction"> </a>
</h2>
<p>The number of close approaches between space objects is increasing due to the proliferation of satellites and debris in orbit. It is a routine operation for satellite operators to avoid probable collisions by conducting maneuvers based on conjunction data messages (CDMs). <strong>The number of CDMs issued weekly are a couple of orders of magnitude larger than the actionable ones</strong>, and this puts pressure on satellite operators. Therefore, an automated process that can predict collision risk with desired accuracy a couple of days ahead to allow satellite operators to plan for collision avoidance maneuvers is desired. In this work, <strong>the feasibility of leveraging deep learning to predict the final collision risk between two space objects from the history of CDMs is investigated</strong>. The CDMs issued for the satellites that ESA's Space Debris Office supports are used to train an ensemble of Manhattan-LSTM models. The proposed ensemble model leverages the similarity scores between the input pairs instead of determining the decision boundary between high and low-risk close approach classes to address the imbalanced data. The significant imbalance and class overlapping in the data is also addressed by casting the problem as an anomaly detection problem and utilizing ensemble of various models. The proposed ensemble model with majority vote can predict collision risks two days ahead with a precision of <strong>91% for high-risk cases</strong> (after adding up the predictions of two-stages). It should ne noted that the solution is two-stage. First stage involves feature engineering and casting the problem as anomaly detection problem by branching normal and anomalous cases with the most important feature, and that gives the precision score of <strong>75% for high-risk cases</strong>. The second stage leverages the Manhattan-LSTM to decide whether each input pairs are similar, and this gives <strong>f1 score of 80%</strong> for anomaly detection of high-risk cases. Therefore, it is possible to determine low-risk to high-risk at close approach time anomalies.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="2.-Data-Preparation">
<a class="anchor" href="#2.-Data-Preparation" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. Data Preparation<a class="anchor-link" href="#2.-Data-Preparation"> </a>
</h2>
<p>Machine  learning models are  sensitive  to  the  training  data,  and  the attributes of the data should be understood before training models with them. The dataset used in this work includes <strong>time-series of CDMs</strong> issued for close approaches between a satellite and a space object.  However, each example includes some information that exists in the standard CDM format, yet not all. The training dataset has 162634 rows (CDMs), 13154 of which are unique close approaches (approximately 12 CDMs for each event), and 103 columns(features from each CDM). Some features from CDMs are probability of collision risk, miss distance, relative position and velocity, solar activity indices,uncertainty in position and velocity, radar cross sections, and some orbitaldata about both space object.  Further details about all features available in the dataset can be accessed on Kelvins platform [1].  Since the training dataset is small, <strong>20 most informative features</strong> are used for training models to makesure the model doesn’t learn the noise in the data.</p>
<p>The training dataset has time-series of CDMs ranging from 7 days to a couple hours before the close approach. ESA Space Debris Office notifies flight teams to plan for possible maneuvers 2 days before the time of the closest approaches for their satellites, and they conduct futher analysis to decide whether to maneuver within 1 day. Since there exists uncertainty in orbit determination and propagation of space objects, it is preffered to start planning for collision avoidance maneuvers <strong>a couple of days ahead of the close approach time to keep uncertainty small and let flight teams have enough time to analyse the maneuvers to be conducted</strong>.</p>
<p>Since it is desired to predict the collision risk two or more days ago, the latest available collision risk value (target label) and a CDM (input features) which is issued two or more days before the close approach should be selected for each close approach event. Figure 1 shows how some input features of a CDM and a collision risk value as a target label (log base 10) are selected as described above to form a candidate input-output pair (most informative features are selected during feature engineering) for training machine learning models from time-series of CDMs.</p>
<p><img src="/blog/images/copied_from_nb/my_icons/input_preparation.png" alt="Figure 1"></p>
<center>Figure 1: The selection of input features and the associated collision risk value as target (log base 10).</center>
<p><strong>Due to my domain expertise</strong>, I directly investigated whether the latest available collision risk values that are issued 2 or more days before the close approach are enough to predict the target risk class accurately, and I realised this was the case. Collision risk is derived from other input features, such as miss distance, position covariance and physical sizes of space objects, and it is an important feature. However, there are <strong>23 cases that are turn out to be high-risk</strong> and <strong>269 cases that turn out to be low-risk</strong> when the latest available collision risk values predict low-risk and high-risk respectively. Therefore, this work casts the collision risk prediction problem as <strong>an anomaly detection problem</strong>. It investigates the feasibility of using machine learning to predict collision risk class (high or low-risk) with desired accuracy by detecting anomalies (Figure 2).</p>
<p><img src="/blog/images/copied_from_nb/my_icons/risk_decision.png" alt="Figure 1"></p>
<center>Figure 2: The outline of sample sizes when the normal and anomaly groups are splitted by the latest available collision risk value.</center>
<p>The dataset has many challenges due to <strong>its small size</strong>, and it is <strong>more sensitive to the quality of data</strong> in general. Imbalance ratio, which is the ratio of the majority to the minority class, is 370 for low-risk target class and 3 for high-risk target class. Anomalies for low-risk target class has only 23 examples which is a challenge to even split data for validation purposes because <strong>the validation dataset should have enough examples for results to be statistically meaningful</strong>. In addition, the total number of samples for high-risk target class is 339. The stratified 3-folds cross-validator is implemented to avoid overfitting. An ensemble of various simple models with different hyperparameters that determines <strong>the similarity in input pairs</strong> is leveraged for better generalization. Figure shows the 2-D feature space representation of some input features  (features  that  fuse  multiple  other  features),  namely  time  to  close approach,  mahalanobis  distance,  maximum  risk  estimate  and  scaling,  and target labels using t-distributed stochastic neighbor embedding (t-SNE) algorithm [2]. It should be noted that due to significant class imbalance and class overlapping high-risk to low-risk anomalies, no statistical model can be developed for that case.</p>
<p><img src="/blog/images/copied_from_nb/my_icons/tsne_collision_risk.png" alt="Figure 1"></p>
<center>Figure 3: T-distributed stochastic neighbor embedding representation of low-risk (left) and high-risk (right) target classes.</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="3.-Manhattan-LSTM-Model">
<a class="anchor" href="#3.-Manhattan-LSTM-Model" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. Manhattan-LSTM Model<a class="anchor-link" href="#3.-Manhattan-LSTM-Model"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There are two neural networks in Manhattan-LSTM model, and they share weights [4]. The model utilizes LSTM to read the features that are derived from CDMs. Then, the similarity score between the input pairs is computed by using the similarity function $g = exp(-|h_{a}-h_{b}|_{1})$ (Figure 4). The LSTM is chosen because it allows variable lengths (to allow missing data to be included) as inputs, and this is not because the inputs are time-series. The total number of pairs for training is 1 million (normal-abnormal), and 10000 pairs are prepared for validation.</p>
<p><img src="/blog/images/copied_from_nb/my_icons/manhattan_lstm_collision.png" alt="Figure 1"></p>
<center>Figure 4: The outline of Manhattan-LSTM model.</center>
<p>Table 1 shows the features that are selected based on the distribution differences between normal and anomalous case.</p>
<table>
<thead>
<tr>
<th>Features</th>
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Time to tca</td>
<td>time_to_tca</td>
<td>Time interval between CDM creation and time-of-closest approach (days)</td>
</tr>
<tr>
<td>Max risk estimate</td>
<td>max_risk_estimate</td>
<td>Maximum collision probability obtained by scaling combined covariance </td>
</tr>
<tr>
<td>Mahalonobis distance</td>
<td>mahalanobis_distance</td>
<td>Miss distance scaled with uncertainty</td>
</tr>
<tr>
<td>Miss distance</td>
<td>miss_distance</td>
<td>Relative position between chaser &amp; target at tca (m)</td>
</tr>
<tr>
<td>Number of CDMs issued</td>
<td>no_larger_2</td>
<td>Number of CDMs issued before 2 days to the tca</td>
</tr>
<tr>
<td>Mean of risk values</td>
<td>mean_larger_2</td>
<td>Mean of collsion risk values for the CDMs issued before 2 days to the tca</td>
</tr>
<tr>
<td>STD of risk values</td>
<td>std_larger_2</td>
<td>STD of collsion risk values for the CDMs issued before 2 days to the tca</td>
</tr>
<tr>
<td>Debris positional uncertainty (cross-track)</td>
<td>c_sigma_n</td>
<td>Covariance (cross-track) position standard deviation (sigma) in meters</td>
</tr>
<tr>
<td>Debris positional uncertainty (along-track)</td>
<td>c_sigma_t</td>
<td>Covariance transverse (along-track) position standard deviation (sigma) in meters</td>
</tr>
<tr>
<td>Debris positional uncertainty (radial)</td>
<td>c_sigma_r</td>
<td>Covariance radial position standard deviation (sigma) in meters</td>
</tr>
<tr>
<td>Debris positional covariance determinant</td>
<td>c_position_covariance_det</td>
<td>Determinant of covariance</td>
</tr>
<tr>
<td>Debris number of observations used</td>
<td>c_obs_used</td>
<td>Number of observations used for orbit determination (per CDM)</td>
</tr>
</tbody>
</table>
<center>Table 1 : Features selected as inputs for Manhattan-LSTM.</center>
<p>Table 2 shows the hyperparameters that are used to train the Manhattan-LSTM.</p>
<table>
<thead>
<tr>
<th>Hyperparameters</th>
<th>Values</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hidden layer size</td>
<td>32</td>
</tr>
<tr>
<td>Batch size</td>
<td>64</td>
</tr>
<tr>
<td>Epoch number</td>
<td>100</td>
</tr>
<tr>
<td>Activation function</td>
<td>tanh</td>
</tr>
<tr>
<td>Dropout</td>
<td>0.05</td>
</tr>
<tr>
<td>Learning rate</td>
<td>2e-5</td>
</tr>
</tbody>
</table>
<center>Table 2 : The hyperparameters that are used to train the Manhattan-LSTM.</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="4.-Results">
<a class="anchor" href="#4.-Results" aria-hidden="true"><span class="octicon octicon-link"></span></a>4. Results<a class="anchor-link" href="#4.-Results"> </a>
</h2>
<p>Figure 5 shows the loss values for both training and validation data, and Figure 5 shows the area-under-curve values during training.</p>
<p><img src="/blog/images/copied_from_nb/my_icons/loss_collision_risk.png" alt="Figure 1"></p>
<center>Figure 5: Loss values for both training and validation data during training.</center>
<p><img src="/blog/images/copied_from_nb/my_icons/auc_collision_risk.png" alt="Figure 1"></p>
<center>Figure 6: AUC values for both training and validation data during training.</center>
<p>In Figure 7, correlation matrix for the test data is presented using the model for the epoch 55, which is the epoch when overfitting starts.</p>
<p><img src="/blog/images/copied_from_nb/my_icons/cm_collision_risk_.png" alt="Figure 1"></p>
<center>Figure 6: AUC values for both training and validation data during training.</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="5.-References">
<a class="anchor" href="#5.-References" aria-hidden="true"><span class="octicon octicon-link"></span></a>5. References<a class="anchor-link" href="#5.-References"> </a>
</h2>
<p>[1] <a href="https://kelvins.esa.int/collision-avoidance-challenge/">https://kelvins.esa.int/collision-avoidance-challenge/</a></p>
<p>[2] Maaten, L.V.D. and Hinton, G., 2008. Visualizing data using t-SNE. Journal of machine learning research, 9(Nov), pp.2579-2605. <a href="http://www.jmlr.org/papers/v9/vandermaaten08a.html">http://www.jmlr.org/papers/v9/vandermaaten08a.html</a></p>
<p>[3] Mueller, J. and Thyagarajan, A., 2016, March. Siamese recurrent architectures for learning sentence similarity. In thirtieth AAAI conference on artificial intelligence. <a href="https://www.aaai.org/ocs/index.php/AAAI/AAAI16/paper/viewPaper/12195">https://www.aaai.org/ocs/index.php/AAAI/AAAI16/paper/viewPaper/12195</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="6.-Code">
<a class="anchor" href="#6.-Code" aria-hidden="true"><span class="octicon octicon-link"></span></a>6. Code<a class="anchor-link" href="#6.-Code"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Load the required libraries</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">fbeta_score</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.sequence</span> <span class="kn">import</span> <span class="n">pad_sequences</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Embedding</span><span class="p">,</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Lambda</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Conv1D</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dropout</span>
<span class="kn">import</span> <span class="nn">tensorflow.keras.backend</span> <span class="k">as</span> <span class="nn">K</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adadelta</span><span class="p">,</span> <span class="n">Adam</span><span class="p">,</span> <span class="n">SGD</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.metrics</span> <span class="kn">import</span> <span class="n">AUC</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">from</span> <span class="nn">datagen</span> <span class="kn">import</span> <span class="n">prepare_data</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'display.max_columns'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#prepare the data to test challenge metric</span>
<span class="c1">#define paths</span>
<span class="n">path_to_dataset</span> <span class="o">=</span> <span class="s1">'dataset/'</span>
<span class="c1">#read the training data</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_dataset</span><span class="p">,</span><span class="s1">'train_data.csv'</span><span class="p">))</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_dataset</span><span class="p">,</span><span class="s1">'test_data.csv'</span><span class="p">))</span>
<span class="c1">#Shapes of the train and test dataset</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"shape of train data </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"shape of test data </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#train time to close approach min and max</span>
<span class="n">train</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">"min"</span><span class="p">,</span><span class="s2">"max"</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#train time to close approach min and max</span>
<span class="n">test</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">"min"</span><span class="p">,</span><span class="s2">"max"</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"number of events that has less than 2.0 days data : "</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">2.0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"event_id"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"number of events that has more than 2.0 days data : "</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">2.0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"event_id"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"total number of events  : "</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"event_id"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
<span class="n">events_less_than_two_days</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">2.0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"event_id"</span><span class="p">)[</span><span class="s2">"event_id"</span><span class="p">]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">events_more_than_two_days</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">2.0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"event_id"</span><span class="p">)[</span><span class="s2">"event_id"</span><span class="p">]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># number of events that has time_to_tca larger and smaller than 2 at the same time</span>
<span class="n">events_trainable</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">events_less_than_two_days</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">events_more_than_two_days</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"number of trainable events : "</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">events_trainable</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#generate new training data that uses last available CDM (closest to 2 days) and adds latest CDM risk as target variable</span>
<span class="n">lenData</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">events_trainable</span><span class="p">)</span>
<span class="n">new_train</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">target_variable</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">no_larger_2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mean_larger_2</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">std_larger_2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mean_nan_number</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">std_nan_number</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lenData</span><span class="p">):</span>
    <span class="n">new_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train</span><span class="p">[(</span><span class="n">train</span><span class="p">[</span><span class="s2">"event_id"</span><span class="p">]</span><span class="o">==</span><span class="n">events_trainable</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">2.0</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">target_variable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train</span><span class="p">[(</span><span class="n">train</span><span class="p">[</span><span class="s2">"event_id"</span><span class="p">]</span><span class="o">==</span><span class="n">events_trainable</span><span class="p">[</span><span class="n">cnt</span><span class="p">])][</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">no_larger_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train</span><span class="p">[(</span><span class="n">train</span><span class="p">[</span><span class="s2">"event_id"</span><span class="p">]</span><span class="o">==</span><span class="n">events_trainable</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">2.0</span><span class="p">)]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mean_larger_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train</span><span class="p">[(</span><span class="n">train</span><span class="p">[</span><span class="s2">"event_id"</span><span class="p">]</span><span class="o">==</span><span class="n">events_trainable</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">2.0</span><span class="p">)]</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">std_larger_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train</span><span class="p">[(</span><span class="n">train</span><span class="p">[</span><span class="s2">"event_id"</span><span class="p">]</span><span class="o">==</span><span class="n">events_trainable</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">2.0</span><span class="p">)]</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">mean_nan_number</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train</span><span class="p">[(</span><span class="n">train</span><span class="p">[</span><span class="s2">"event_id"</span><span class="p">]</span><span class="o">==</span><span class="n">events_trainable</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">2.0</span><span class="p">)]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">std_nan_number</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train</span><span class="p">[(</span><span class="n">train</span><span class="p">[</span><span class="s2">"event_id"</span><span class="p">]</span><span class="o">==</span><span class="n">events_trainable</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s2">"time_to_tca"</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">2.0</span><span class="p">)]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">new_traintrain_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_train</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="c1">#add target value to the dataset</span>
<span class="n">target_variable_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">target_variable</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"target_risk"</span><span class="p">])</span>
<span class="n">no_larger_2_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">no_larger_2</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"no_larger_2"</span><span class="p">])</span>
<span class="n">mean_larger_2_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mean_larger_2</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"mean_larger_2"</span><span class="p">])</span>
<span class="n">std_larger_2_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">std_larger_2</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"std_larger_2"</span><span class="p">])</span>
<span class="n">mean_nan_number_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mean_nan_number</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"mean_nan_number"</span><span class="p">])</span>
<span class="n">std_nan_number_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">std_nan_number</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"std_nan_number"</span><span class="p">])</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s2">"target_risk"</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_variable_pd</span><span class="o">.</span><span class="n">values</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s2">"no_larger_2"</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_larger_2_pd</span><span class="o">.</span><span class="n">values</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s2">"mean_larger_2"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_larger_2_pd</span><span class="o">.</span><span class="n">values</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s2">"std_larger_2"</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_larger_2_pd</span><span class="o">.</span><span class="n">values</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s2">"mean_nan_number"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_nan_number_pd</span><span class="o">.</span><span class="n">values</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s2">"std_nan_number"</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_nan_number_pd</span><span class="o">.</span><span class="n">values</span>
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Determines the high risk events</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'target_risk_class'</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'target_risk'</span><span class="p">]</span><span class="o">&gt;=-</span><span class="mf">6.0</span><span class="p">,</span><span class="s1">'target_risk_class'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'target_risk'</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">6.0</span><span class="p">,</span><span class="s1">'target_risk_class'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"number of high risk events"</span><span class="p">,</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'target_risk_class'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"number of low risk events"</span><span class="p">,</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'target_risk_class'</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"ratio of high risk versus low risk "</span><span class="p">,</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'target_risk_class'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'target_risk_class'</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Uses the latest available risk value to determine the normal and anomalous cases</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'risk'</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">6.0</span><span class="p">,</span><span class="s1">'predicted_risk'</span><span class="p">]</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">6.000000000000001</span>
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'risk'</span><span class="p">]</span><span class="o">&gt;=-</span><span class="mf">6.0</span><span class="p">,</span><span class="s1">'predicted_risk'</span><span class="p">]</span> <span class="o">=</span>  <span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'risk'</span><span class="p">]</span> <span class="o">&gt;=-</span><span class="mf">6.0</span><span class="p">]</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">values</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Assigns the classes based on risk values</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk_class'</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk'</span><span class="p">]</span><span class="o">&gt;=-</span><span class="mf">6.0</span><span class="p">,</span><span class="s1">'predicted_risk_class'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk'</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">6.0</span><span class="p">,</span><span class="s1">'predicted_risk_class'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"number of high risk events with above criterion"</span><span class="p">,</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk_class'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"number of low risk events with above criterion"</span><span class="p">,</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk_class'</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"ratio of high risk versus low risk with above criterion"</span><span class="p">,</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk_class'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk_class'</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk_anomaly'</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk'</span><span class="p">]</span><span class="o">&gt;=-</span><span class="mf">6.0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'target_risk'</span><span class="p">]</span><span class="o">&gt;=-</span><span class="mf">6.0</span><span class="p">),</span><span class="s1">'predicted_risk_anomaly'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk'</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">6.0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'target_risk'</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">6.0</span><span class="p">),</span><span class="s1">'predicted_risk_anomaly'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk'</span><span class="p">]</span><span class="o">&gt;=-</span><span class="mf">6.0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'target_risk'</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">6.0</span><span class="p">),</span><span class="s1">'predicted_risk_anomaly'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk'</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">6.0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'target_risk'</span><span class="p">]</span><span class="o">&gt;=-</span><span class="mf">6.0</span><span class="p">),</span><span class="s1">'predicted_risk_anomaly'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"number of 0 to 1 risk anomaly events with above criterion"</span><span class="p">,</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk_anomaly'</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"number of 1 to 0 risk anomaly events with above criterion"</span><span class="p">,</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk_anomaly'</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"number of 0 to 0 risk events with above criterion"</span><span class="p">,</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk_anomaly'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"number of 1 to 1 risk events with above criterion"</span><span class="p">,</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'predicted_risk_anomaly'</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#convert categorical c_object_type</span>
<span class="n">le</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s2">"c_object_type"</span><span class="p">]</span> <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s2">"c_object_type"</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Computes the missing value percentage</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"key : </span><span class="si">{}</span><span class="s2"> ----&gt; missing data (percentage) :</span><span class="si">{}</span><span class="s2"> %"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>\
                                                                      <span class="n">value</span><span class="o">/</span><span class="mf">8892.0</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Fills missing values with mean values and checks whether there exist more missing data</span>
<span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">new_traintrain_pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"key : </span><span class="si">{}</span><span class="s2"> ----&gt; missing data (percentage) :</span><span class="si">{}</span><span class="s2"> %"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span>\
                                                                      <span class="n">value</span><span class="o">/</span><span class="mf">8892.0</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Scales the input data for standard scaler</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="n">qt_risk</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_risk'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_risk</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'risk'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_risk'] = qt_risk.transform(np.expand_dims(new_test_pd['risk'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_risk'])</span>
<span class="n">qt_time_to_tca</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_time_to_tca'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_time_to_tca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'time_to_tca'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_time_to_tca'] = qt_time_to_tca.transform(np.expand_dims(new_test_pd['time_to_tca'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_time_to_tca'])</span>
<span class="n">qt_max_risk_estimate</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_max_risk_estimate'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_max_risk_estimate</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'max_risk_estimate'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_max_risk_estimate'] = qt_max_risk_estimate.transform(np.expand_dims(new_test_pd['max_risk_estimate'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_max_risk_estimate'])</span>
<span class="n">qt_max_risk_scaling</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_max_risk_scaling'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_max_risk_scaling</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'max_risk_scaling'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_max_risk_scaling'] = qt_max_risk_scaling.transform(np.expand_dims(new_test_pd['max_risk_scaling'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_max_risk_scaling'])</span>
<span class="n">qt_mahalanobis_distance</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_mahalanobis_distance'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_mahalanobis_distance</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'mahalanobis_distance'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_mahalanobis_distance'] = qt_mahalanobis_distance.transform(np.expand_dims(new_test_pd['mahalanobis_distance'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_mahalanobis_distance'])</span>
<span class="n">qt_miss_distance</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_miss_distance'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_miss_distance</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'miss_distance'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_miss_distance'] = qt_miss_distance.transform(np.expand_dims(new_test_pd['miss_distance'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_miss_distance'])</span>
<span class="n">qt_no_larger_2</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_no_larger_2'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_no_larger_2</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'no_larger_2'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_no_larger_2'] = qt_no_larger_2.transform(np.expand_dims(new_test_pd['no_larger_2'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_no_larger_2'])</span>
<span class="n">qt_mean_larger_2</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_mean_larger_2'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_mean_larger_2</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'mean_larger_2'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_mean_larger_2'] = qt_mean_larger_2.transform(np.expand_dims(new_test_pd['mean_larger_2'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_mean_larger_2'])</span>
<span class="n">qt_std_larger_2</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_std_larger_2'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_std_larger_2</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'std_larger_2'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_std_larger_2'] = qt_std_larger_2.transform(np.expand_dims(new_test_pd['std_larger_2'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_std_larger_2'])</span>
<span class="n">qt_c_sigma_n</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_c_sigma_n'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_c_sigma_n</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'c_sigma_n'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_c_sigma_n'] = qt_c_sigma_n.transform(np.expand_dims(new_test_pd['c_sigma_n'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_c_sigma_n'])</span>
<span class="n">qt_c_sigma_t</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_c_sigma_t'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_c_sigma_t</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'c_sigma_t'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_c_sigma_t'] = qt_c_sigma_t.transform(np.expand_dims(new_test_pd['c_sigma_t'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_c_sigma_t'])</span>
<span class="n">qt_c_sigma_r</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_c_sigma_r'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_c_sigma_r</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'c_sigma_r'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_c_sigma_r'] = qt_c_sigma_r.transform(np.expand_dims(new_test_pd['c_sigma_r'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_c_sigma_r'])</span>
<span class="n">qt_c_position_covariance_det</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_c_position_covariance_det'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_c_position_covariance_det</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'c_position_covariance_det'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_c_position_covariance_det'] = qt_c_position_covariance_det.transform(np.expand_dims(new_test_pd['c_position_covariance_det'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_c_position_covariance_det'])</span>
<span class="n">qt_c_obs_used</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'qt_c_obs_used'</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt_c_obs_used</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">[</span><span class="s1">'c_obs_used'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># new_test_pd['qt_c_obs_used'] = qt_c_obs_used.transform(np.expand_dims(new_test_pd['c_obs_used'].values,axis=1))</span>
<span class="c1"># sns.distplot(new_traintrain_pd['qt_c_obs_used'])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Prepares the data for Manhattan-LSTM</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">X_train_val</span><span class="p">,</span> <span class="n">Y_train_val</span><span class="p">,</span> <span class="n">new_data_pd</span> <span class="o">=</span> <span class="n">prepare_data</span><span class="p">(</span><span class="n">new_traintrain_pd</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Model variables</span>
<span class="n">n_hidden</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">gradient_clipping_norm</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">n_epoch</span> <span class="o">=</span> <span class="mi">100</span>
<span class="k">def</span> <span class="nf">exponent_neg_manhattan_distance</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
    <span class="sd">''' Helper function for the similarity estimate of the LSTMs outputs'''</span>
    <span class="k">return</span> <span class="n">K</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">left</span><span class="o">-</span><span class="n">right</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">left_input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_data_pd</span><span class="o">.</span><span class="n">feature1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
<span class="n">right_input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_data_pd</span><span class="o">.</span><span class="n">feature1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">left_input</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># Since this is a siamese network, both sides share the same LSTM</span>
<span class="n">shared_lstm</span> <span class="o">=</span> <span class="n">LSTM</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s1">'tanh'</span><span class="p">,</span><span class="n">dropout</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">left_output</span> <span class="o">=</span> <span class="n">shared_lstm</span><span class="p">(</span><span class="n">left_input</span><span class="p">)</span>
<span class="n">right_output</span> <span class="o">=</span> <span class="n">shared_lstm</span><span class="p">(</span><span class="n">right_input</span><span class="p">)</span>
<span class="c1"># Calculates the distance as defined by the MaLSTM model</span>
<span class="n">malstm_distance</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">exponent_neg_manhattan_distance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">output_shape</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))([</span><span class="n">left_output</span><span class="p">,</span> <span class="n">right_output</span><span class="p">])</span>
<span class="c1"># Pack it all up into a model</span>
<span class="n">malstm</span> <span class="o">=</span> <span class="n">Model</span><span class="p">([</span><span class="n">left_input</span><span class="p">,</span> <span class="n">right_input</span><span class="p">],</span> <span class="p">[</span><span class="n">malstm_distance</span><span class="p">])</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.00002</span><span class="p">,</span><span class="n">decay</span><span class="o">=</span><span class="mf">0.000002</span><span class="p">)</span>
<span class="n">malstm</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">'mean_squared_error'</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">AUC</span><span class="p">()])</span>
<span class="c1"># Start training</span>
<span class="n">training_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="c1"># Include the epoch in the file name (uses `str.format`)</span>
<span class="n">checkpoint_path</span> <span class="o">=</span> <span class="s2">"cp_epoch_</span><span class="si">{epoch:04d}</span><span class="s2">.ckpt"</span>
<span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span>
<span class="c1"># Create a callback that saves the model's weights every 5 epochs</span>
<span class="n">cp_callback</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span>
    <span class="n">filepath</span><span class="o">=</span><span class="n">checkpoint_path</span><span class="p">,</span> 
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">malstm_trained</span> <span class="o">=</span> <span class="n">malstm</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="n">X_train</span><span class="p">[</span><span class="s1">'left'</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]],</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="n">n_epoch</span><span class="p">,</span>
                            <span class="n">validation_data</span><span class="o">=</span><span class="p">([</span><span class="n">X_train_val</span><span class="p">[</span><span class="s1">'left'</span><span class="p">],</span> <span class="n">X_train_val</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]],</span> <span class="n">Y_train_val</span><span class="p">),</span><span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">cp_callback</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Training time finished.</span><span class="se">\n</span><span class="si">{}</span><span class="s2"> epochs in </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_epoch</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">training_start_time</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">malstm_trained</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">'loss'</span><span class="p">],</span><span class="s1">'r-.'</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">'loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">malstm_trained</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">],</span><span class="s1">'g-*'</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">'val_loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">malstm_trained</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">'auc'</span><span class="p">],</span><span class="s1">'r-.'</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">'auc'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">malstm_trained</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_auc'</span><span class="p">],</span><span class="s1">'g-*'</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">'val_auc'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Iterations'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Auc'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="k">def</span> <span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span><span class="n">classes</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">'confusion matrix'</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float'</span><span class="p">)</span><span class="o">/</span><span class="n">cm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'normalized'</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'not normalized'</span><span class="p">)</span>
  <span class="c1"># print(cm)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s1">'nearest'</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
  <span class="n">tick_marks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">tick_marks</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">tick_marks</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">fmt</span> <span class="o">=</span> <span class="s1">'.2f'</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="s1">'d'</span>
  <span class="n">thresh</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="nb">format</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">fmt</span><span class="p">),</span><span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">'white'</span> <span class="k">if</span> <span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="n">thresh</span> <span class="k">else</span> <span class="s1">'black'</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'True Label'</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Predicted Label'</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">'cp_epoch_0055.ckpt'</span>
<span class="n">malstm</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">p_test</span> <span class="o">=</span> <span class="n">malstm</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">X_train_val</span><span class="p">[</span><span class="s1">'left'</span><span class="p">],</span> <span class="n">X_train_val</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]])</span>
<span class="n">p_test_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">p_test</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'prob'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">p_test_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p_test_pd</span><span class="p">[</span><span class="s1">'prob'</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.5</span><span class="p">,</span><span class="s1">'prob'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">p_test_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p_test_pd</span><span class="p">[</span><span class="s1">'prob'</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">,</span><span class="s1">'prob'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">Y_train_val</span><span class="p">,</span><span class="n">p_test_pd</span><span class="o">.</span><span class="n">prob</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sklearn</span>
<span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">f1_score</span><span class="p">(</span><span class="n">Y_train_val</span><span class="p">,</span><span class="n">p_test_pd</span><span class="o">.</span><span class="n">prob</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="rasitabay/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/collision%20risk/satellites/deep%20learning/manhattan-lstm/2020/04/22/ESA-Collision-Risk-Prediction.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Blog posts related to data scienece and machine learning for real life.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/rasitabay" title="rasitabay"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/abayrasit" title="abayrasit"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
